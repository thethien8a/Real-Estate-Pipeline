-- H√†m clean area 
CREATE OR REPLACE FUNCTION clean_area(raw TEXT)
RETURNS DOUBLE PRECISION AS $$
DECLARE
    num TEXT;
BEGIN
    IF raw IS NULL OR raw = '' THEN 
        RETURN NULL;
    END IF;

    raw := lower(raw);

    -- Ch·ªâ gi·ªØ s·ªë, d·∫•u ph·∫©y, d·∫•u ch·∫•m
    num := regexp_replace(raw, '[^0-9,\.]', '', 'g');

    -- "47,7" ‚Üí "47.7"
    num := replace(num, ',', '.');

    RETURN num::double precision;

EXCEPTION WHEN OTHERS THEN
    RETURN NULL;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

--Clean price
CREATE OR REPLACE FUNCTION clean_price(raw TEXT)
RETURNS DOUBLE PRECISION AS $$
DECLARE
    num TEXT;
    number_value DOUBLE PRECISION;
BEGIN
    IF raw IS NULL OR raw = '' THEN 
        RETURN NULL;
    END IF;

    -- Convert to lower case
    raw := lower(raw);

    -- B·ªè d·∫•u ch·∫•m ngƒÉn c√°ch ngh√¨n
    raw := replace(raw, '.', '');

    -- Gi·ªØ l·∫°i s·ªë, d·∫•u ph·∫©y, d·∫•u ch·∫•m
    num := regexp_replace(raw, '[^0-9,\.]', '', 'g');

    -- ƒê·ªïi d·∫•u ',' ‚Üí '.'
    num := replace(num, ',', '.');

    -- Chuy·ªÉn v·ªÅ s·ªë
    number_value := num::double precision;

    -- T√≠nh h·ªá s·ªë ƒë∆°n v·ªã (tri·ªáu / t·ª∑)
    IF raw LIKE '%t·ª∑%' THEN
        number_value := number_value * 1000000000;
    ELSIF raw LIKE '%tr%' OR raw LIKE '%tri·ªáu%' THEN
        number_value := number_value * 1000000;
    END IF;

    RETURN number_value;

EXCEPTION WHEN OTHERS THEN
    RETURN NULL;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

--view check data
CREATE OR REPLACE VIEW bronze.qc_daily_overview AS
SELECT 
    DATE(crawled_at) AS crawl_date,

    -- T·ªïng s·ªë b·∫£n ghi trong ng√†y
    COUNT(*) AS total_records,

    -- ============================
    -- üî¥ Missing Required Fields
    -- ============================

    SUM(CASE WHEN title IS NULL OR title = '' THEN 1 ELSE 0 END) AS missing_title,
    SUM(CASE WHEN address IS NULL OR address = '' THEN 1 ELSE 0 END) AS missing_address,
    SUM(CASE WHEN price IS NULL OR price = '' THEN 1 ELSE 0 END) AS missing_price,
    SUM(CASE WHEN area IS NULL OR area = '' THEN 1 ELSE 0 END) AS missing_area,
    SUM(CASE WHEN house_direction IS NULL OR house_direction = '' THEN 1 ELSE 0 END) AS missing_house_direction,

    -- ‚≠ê NEW: C√°c missing m·ªõi b·∫°n y√™u c·∫ßu
    SUM(CASE WHEN balcony_direction IS NULL OR balcony_direction = '' THEN 1 ELSE 0 END) AS missing_balcony_direction,
    SUM(CASE WHEN facade IS NULL OR facade = '' THEN 1 ELSE 0 END) AS missing_facade,
    SUM(CASE WHEN legal IS NULL OR legal = '' THEN 1 ELSE 0 END) AS missing_legal,
    SUM(CASE WHEN furniture IS NULL OR furniture = '' THEN 1 ELSE 0 END) AS missing_furniture,
    SUM(CASE WHEN number_bedroom IS NULL OR number_bedroom = '' THEN 1 ELSE 0 END) AS missing_number_bedroom,
    SUM(CASE WHEN number_bathroom IS NULL OR number_bathroom = '' THEN 1 ELSE 0 END) AS missing_number_bathroom,
    SUM(CASE WHEN number_floor IS NULL OR number_floor = '' THEN 1 ELSE 0 END) AS missing_number_floor,
    SUM(CASE WHEN way_in IS NULL OR way_in = '' THEN 1 ELSE 0 END) AS missing_way_in,
    SUM(CASE WHEN post_start_time IS NULL OR post_start_time = '' THEN 1 ELSE 0 END) AS missing_post_start_time,
    SUM(CASE WHEN post_end_time IS NULL OR post_end_time = '' THEN 1 ELSE 0 END) AS missing_post_end_time,
    SUM(CASE WHEN post_type IS NULL OR post_type = '' THEN 1 ELSE 0 END) AS missing_post_type,

    -- Ki·ªÉm tra ƒë·ªãnh d·∫°ng gi√° kh√¥ng h·ª£p l·ªá
    SUM(CASE WHEN clean_price(price) IS NULL THEN 1 ELSE 0 END) AS invalid_price_format,

    -- Ki·ªÉm tra di·ªán t√≠ch kh√¥ng h·ª£p l·ªá
    SUM(CASE WHEN clean_area(area) IS NULL THEN 1 ELSE 0 END) AS invalid_area_format,

    -- Gi√° b·∫•t th∆∞·ªùng
    SUM(
        CASE WHEN clean_price(price) IS NOT NULL 
        AND clean_price(price) < 200000000 
        THEN 1 ELSE 0 END
    ) AS suspicious_low_price,

    SUM(
        CASE WHEN clean_price(price) IS NOT NULL 
        AND clean_price(price) > 200000000000 
        THEN 1 ELSE 0 END
    ) AS suspicious_high_price,

    -- Di·ªán t√≠ch b·∫•t th∆∞·ªùng
    SUM(
        CASE WHEN clean_area(area) IS NOT NULL 
        AND clean_area(area) < 10 
        THEN 1 ELSE 0 END
    ) AS suspicious_small_area,

    SUM(
        CASE WHEN clean_area(area) IS NOT NULL 
        AND clean_area(area) > 2000 
        THEN 1 ELSE 0 END
    ) AS suspicious_large_area
FROM bronze.staging
GROUP BY DATE(crawled_at)
ORDER BY crawl_date DESC;


-- g·ªçi v·ªâew quality check 
SELECT * FROM bronze.qc_daily_overview;
Select * from bronze.staging
--
